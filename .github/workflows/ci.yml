name: CI (smoke)
on: [push, pull_request]
jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      ALLOW_FAKE_GEN: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
      - name: Launch API
        run: |
          python -m uvicorn src.api.server:app --host 127.0.0.1 --port 9100 &
          echo $! > .uv.pid
          sleep 4
      - name: Health
        run: curl -sSf http://127.0.0.1:9100/health
      - name: Infer
        run: |
          curl -sSf -H "Content-Type: application/json" \
            --data '{"prompt":"ping","max_new_tokens":8}' \
            http://127.0.0.1:9100/v1/infer | tee out.json
      - name: Stop
        if: always()
        run: kill $(cat .uv.pid) || true
