<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Blueprint STL Viewer</title>
<style>
 body{font-family:system-ui,Arial;margin:0;display:flex;height:100vh}
 #left{width:320px;border-right:1px solid #ddd;padding:12px;overflow:auto}
 #right{flex:1;position:relative;background:#111}
 .btn{padding:8px 12px;margin:6px 0;display:inline-block;border:1px solid #888;cursor:pointer}
 ul{list-style:none;padding:0;margin:0}
 li{margin:4px 0}
 canvas{display:block}
 .small{color:#666;font-size:12px}
</style>
</head>
<body>
<div id="left">
  <h3>Blueprint UI</h3>
  <div><span class="btn" id="gen">Generate Pareto + STL</span></div>
  <div id="status" class="small">Ready.</div>
  <h4>STL files</h4>
  <ul id="stl"></ul>
  <h4>Pareto</h4>
  <ul id="par"></ul>
  <h4>Manifest</h4>
  <pre id="manifest" class="small"></pre>
</div>
<div id="right"><canvas id="cv"></canvas></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158/examples/js/loaders/STLLoader.js"></script>
<script>
const api = path => (location.origin + "/ui" + path);

async function refresh(){
  const j = await (await fetch(api("/list"))).json();
  const stl = document.getElementById("stl"); stl.innerHTML="";
  j.stl.forEach(it=>{
    const li=document.createElement("li");
    const a=document.createElement("a");
    a.href="#"; a.textContent=it.name+" ("+it.bytes+"B)";
    a.onclick=()=>loadSTL("data/geometry/"+it.name);
    li.appendChild(a); stl.appendChild(li);
  });
  const par = document.getElementById("par"); par.innerHTML="";
  j.pareto.forEach(it=>{
    const li=document.createElement("li");
    const a=document.createElement("a");
    a.href = "/ui/file?path="+encodeURIComponent("data/pareto/"+it.name);
    a.textContent=it.name+" ("+it.bytes+"B)";
    li.appendChild(a); par.appendChild(li);
  });
  document.getElementById("manifest").textContent = JSON.stringify(await (await fetch(api("/manifest"))).json(), null, 2);
}

document.getElementById("gen").onclick = async ()=>{
  document.getElementById("status").textContent="Generating...";
  const r = await fetch(api("/generate"), {method:"POST"});
  const j = await r.json();
  document.getElementById("status").textContent = j.ok ? ("Done in "+j.t_sec+"s") : ("Error: "+j.error);
  refresh();
};

// THREE viewer
let scene, camera, renderer, controls, mesh;
function init3() {
  const canvas = document.getElementById("cv");
  renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  onResize(); window.addEventListener("resize", onResize);
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x111111);
  camera = new THREE.PerspectiveCamera(50, 2, 0.1, 1000);
  camera.position.set(2,1.5,3);
  controls = new THREE.OrbitControls(camera, renderer.domElement);
  const l1 = new THREE.DirectionalLight(0xffffff, 1.0); l1.position.set(3,5,2); scene.add(l1);
  const l2 = new THREE.AmbientLight(0xffffff, 0.3); scene.add(l2);
  animate();
}
function onResize(){
  const r = document.getElementById("right");
  const w=r.clientWidth, h=r.clientHeight;
  renderer.setSize(w,h); if(camera){camera.aspect=w/h; camera.updateProjectionMatrix();}
}
function animate(){ requestAnimationFrame(animate); renderer.render(scene, camera); }
async function loadSTL(path){
  const url = "/ui/file?path="+encodeURIComponent(path);
  const loader = new THREE.STLLoader();
  loader.load(url, geo=>{
    if(mesh){ scene.remove(mesh); }
    const mat = new THREE.MeshPhongMaterial({color:0x8899ff, specular:0x222222, shininess:30});
    mesh = new THREE.Mesh(geo, mat);
    geo.computeBoundingSphere();
    const bs = geo.boundingSphere;
    mesh.position.set(0,0,0);
    scene.add(mesh);
    camera.position.set(bs.radius*2, bs.radius*1.2, bs.radius*2.4);
    controls.update();
  });
}

init3(); refresh();
</script>
</body>
</html>
